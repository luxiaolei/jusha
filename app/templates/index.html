<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<html>

<head>
  <title>Example for the d3.js export from mapper</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <script type="text/javascript" src="{{
  url_for('static', filename='js/jquery-2.1.4.min.js') }}"></script>
<script type="text/javascript" src="http://brandonaaron.net/javascripts/plugins/livequery.js"></script>
  <script type="text/javascript">
    var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
  </script>

  <script type="text/javascript">
  //handle feater selection porcess
  $(function(){
    $("#showfeature").bind('click', function(){
      $.getJSON($SCRIPT_ROOT + '/features',function(data){
        //retrive features from json, and then generate
        //a list of radio button for each features
       for (i in data.features){
         var radioBtn = $('<input type="radio" name="features" value= '+data.features[i]+'>'+data.features[i]+'<br/>');
         radioBtn.appendTo('#radiocheck');
         }
      //ajax post the selected feature to server
       $('#radiocheck input').change(function(){
         var data = {'selected': $('input[name=features]:checked', '#radiocheck').val()};

         $.ajax({
           type : "POST",
           url : "{{ url_for('feature_ajax') }}",
           data: JSON.stringify(data),// null, '\t'),
           contentType: 'application/json;charset=UTF-8',
           success: function(result){
             /*
             //update d3 nodes arrtributes
             var nodes = JSON.parse(result);
             max_arrt = [];
             for(n in nodes) {
               //console.log(nodes[n].attribute)
               var elm = nodes[n].attribute;

               max_arrt.push(nodes[n].attribute);
             }
             var max_value = Math.max(max_arrt)

             var fscale = d3.scale.linear()
             .range(['blue','red'])
             .domain([0,16]);


                d3.select("#graph")
                .selectAll(".node")
                .data(nodes)
                .transition()
                .duration(1500)
			          .delay(1500)
                .style("fill", function(e) { return fscale(e.attribute);})
              */
           }
         });
        });
      });
    });
  });
  </script>

  <script type="text/javascript">
  //search data utility
  $(function(){
    $('#searchsubmit').bind('click',function(){
      /*
      !!should add a function(searchbox){return index}!
      */
      var dataname = parseInt($('#searchbox').val());

      //retrive the indexes of nodes which contain the searched data
      $.getJSON($SCRIPT_ROOT + '/mapperjson', function(data){
        var nodes = data['vertices'];
        var exsitIndexes = [];
        for (i in nodes){
          var members = nodes[i]['members'];
          var flag = $.inArray(dataname, members);
          if (flag != -1){
            var theNode = nodes[i]['index']
            exsitIndexes.push(theNode);
          };
        };

        var modExsitIndexes = []
        for (i in exsitIndexes){
          var eid = 'circleid_'+exsitIndexes[i];
          modExsitIndexes.push(eid);}

        var svg = d3.select('svg');
        var noneExsitIndexes = [];
        svg.selectAll('.node')
           .each(function(d,i){
             //find the id of node which does NOT contain the search data
             var flag = $.inArray(this.id, modExsitIndexes);
             if (flag == -1){
               noneExsitIndexes.push(this.id)
             }
           })

        //do the coloring!
        for (i in modExsitIndexes){
          svg.select('#'+modExsitIndexes[i])
             .transition()
             .style('opacity', 1)
        };
        for (i in noneExsitIndexes){
          svg.select('#'+noneExsitIndexes[i])
             .transition()
             .style('opacity', 0.3)
        }
      })

    })

  })

  </script>

  <style>
    .link {
      stroke: #999;
      stroke-opacity: .6;
    }
  </style>
</head>

<body>

  <h2>Please give me your file! Only csv txt are supported!</h2>
  <form action="/" method=post enctype=multipart/form-data>
    <input type=file id=test name=file>
    <input type=submit id=filesubmit2 value=Upload>
  </form>

  <span type='button' id=showfeature value='show features'>show features</span>

  <div class=options id="radiocheck"></div>

  <div id=members></div>

  {% if featureflag %}
  <p>Your selected feature is: {{selected_f}}</p>
  <p>
    The min value of the feature is: {{minvalue}}<br>
    The max value of the feature is: {{maxvalue}}
  </p>

  <form action="/" method=post enctype=multipart/form-data>
  <input type='text' name='range'/>
  <input type='submit' value='start!'/>
  </form>

  <p>
    The index of points ly in the feature's range are:
    {{rangeindex}}
  </p>
  {% endif %}

  <button class=changecolor value=refresh>refresh</button>

  <br/>
  Search Data:
  <input type='text' name='search' id='searchbox' />
  <button id='searchsubmit'>search!</button>
  <div id="graph"></div>

  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="{{ url_for('static', filename = 'js/force_layout.js') }}"></script>

</body>

</html>
